---
title: "R Notebook"
output:
  html_notebook: default
  pdf_document: default
---

```{r}
library(tidyverse)
library(ggplot2)
library(readxl)
library(stringr)
library(lubridate)

print(getwd())

FY <- function(year)
{
  function(rec)
  {
    (rec$year==(year-1) & rec$month>=9)|(rec$year==year & rec$month<9)
  }
}

fiscal.yr<-function(year, month)
{
  year <- year + ifelse(month>=9,1,0)
}
fiscal.year<-function(recs)
{
  fiscal.yr(recs$year, recs$month)
}
fiscal.month<-function(recs)
{
  recs$month + ifelse(recs$month>=9, -9, +3)
}
```

EXAMPLES of how to adjust date columns:
names(all.charges) <- make.names(colnames(all.charges))
tmp<-as.POSIXlt(all.charges$Timecard.Start)
all.charges <- all.charges %>% mutate(year=tmp$year-100+2000,month=tmp$mon)

unlist(as.POSIXlt(all.charges$Timecard.End[5001]))
sec   min  hour  mday   mon  year  wday  yday isdst 
  0     0     0    22     4   122     0   141     0 
  

```{r}
datepart<-'Dec2022FY24Scenario'
datepart<-'Dec2022FY24ScenarioUpdated' # with delayed M&S
datepart<-'Dec2022FY23' # limited to 5.4M spending
#datepart<-'Dec2022StatusInput'
datapart<-'Dec2022Current'

read.my.file <- function(datepart, tab)
{
  fname<-paste('extracted/tab_',tab,'_',datepart,'.csv',sep='')
  df <- read.csv(fname)
  df
}

# these come from XER extractor
taskrsrc<-read.my.file(datepart, 'TASKRSRC')
rsrc<-read.my.file(datepart, "RSRC")
wbs<-read.my.file(datepart, "PROJWBS")
tasks<-read.my.file(datepart,"TASK")
# this is a summary of the above out of reader.py -P -d
all.data<-read.csv("output/alltasks.csv")
all.paths<-read.csv("output/allareas.csv")
```

```{r}
path.data <- left_join(all.paths, all.data, by=join_by(code))
```


Sequence is 
Find line in TASKRSRC, first two columns are IDs: taskrsrc_id, task_id
Find task_id in TASK: there is a task ID and task name here, and task_id,proj_id,wbs_id.
Find wbs_id in PROJWBS: the name of this area is found here

```{r}
#view(all.data%>%select(name, wbs, category, group, wbs_high, wbs_low))

tmp<-filter(path.data, year(target_start)>2021 & type!='Q' & wbs!='01.01')
tmp$g=as.numeric(as.factor(tmp$group))
tmp$a=as.numeric(as.factor(tmp$area))
tmp$p=as.numeric(as.factor(tmp$path))

# started with label=code
# y_discrete = "group"
# y = group
# ymin = g, ymax = g+.8
gp<-ggplot(tmp, aes(xmin = as.Date(target_start), xmax = as.Date(target_end), 
                   y=as.factor(path),# ymin = g, ymax = g+.8, 
                   fill = category)) +
  geom_rect(aes(ymin = p, ymax = p+.8)) +
  scale_y_discrete("path") +
  scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90)) + 
  geom_text(aes(x = as.Date(target_start), label = wbs), nudge_x=39.6, nudge_y=.2, size=3)#, check_overlap = TRUE)

ggsave(gp, filename="vs.pdf",units="in", height=10, width=24, device="pdf")
print(gp)
```

```{r}
sched <- tasks %>% left_join(wbs, by=join_by(wbs_id)) %>% select( task_id, target_start_date, target_end_date, task_code, task_name, wbs_id, wbs_name, wbs_short_name) %>% arrange(target_start_date)
```


```{r}
costs <- filter(taskrsrc,target_cost>0) %>% left_join(tasks,by=join_by(task_id))%>%left_join(wbs, by=join_by(wbs_id)) %>% select( task_id, target_cost, cost_per_qty, target_start_date.x, target_end_date.x, task_code, task_name, wbs_id, wbs_name, wbs_short_name) %>% arrange(target_start_date.x)
#view(costs)
```


```{r}
group.cat <- ggplot(all.data,aes(x=group, y=category)) + theme(axis.text.x = element_text(angle = 90)) + geom_count()
group.area <- ggplot(all.data,aes(x=group, y=wbs_high)) + theme(axis.text.x = element_text(angle = 90)) + geom_count()
cat.area <- ggplot(all.data,aes(x=category, y=wbs_high)) + theme(axis.text.x = element_text(angle = 90)) + geom_count()
print(group.cat)
print(group.area)
print(cat.area)
```

```{r}
stop.code.list <- read.csv("code_list.csv",header=TRUE)
```

The lines that are wrong values are:

179259425 A1701AA10   rsrc_type = RT_Equip for the 240 in taskrsrc
179259423 A1701N10    Same thing is true for this one, for the 240

X Now task_id 179259445 is missing!!! (value of 60 hours) task_code A1803770

A1802700 is missing
A1803460 seems to be missing
A1803770 is missing


```{r}
# get all the tasks that match our task_code
stopped.tasks <- left_join(stop.code.list, tasks, by=join_by(task_code)) %>% select(task_id, task_code, target_work_qty,rsrc_id, task_name)

# get all the taskrsrc records that match our task_id
stopped.taskrsrc <- left_join(stopped.tasks, filter(taskrsrc,rsrc_type=='RT_Labor'),multiple='all', by=join_by(task_id)) %>% select(task_id, task_code, rsrc_id.x, rsrc_id.y, target_qty, target_work_qty, rsrc_type)

stopped.rsrcs <- stopped.taskrsrc %>% left_join(filter(rsrc,rsrc_type=='RT_Labor'),by=join_by(rsrc_id.y==rsrc_id)) %>% select(task_id, task_code, rsrc_name, rsrc_id.y, target_qty, target_work_qty, rsrc_name, rsrc_type.x) %>% filter(!is.na(target_qty))


hours.sum <-select(stopped.rsrcs,rsrc_id.y,task_code,rsrc_name,target_qty) %>% group_by(rsrc_name) %>% summarise(total.hours=sum(target_qty))

```

