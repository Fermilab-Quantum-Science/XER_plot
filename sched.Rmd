---
title: "R Notebook"
output:
  html_notebook: default
  pdf_document: default
---

```{r message=FALSE, warning=FALSE}
#```{r}
library(tidyverse)
library(ggplot2)
library(readxl)
library(stringr)
library(lubridate)


print(getwd())

FY <- function(year)
{
  function(rec)
  {
    (rec$year==(year-1) & rec$month>=9)|(rec$year==year & rec$month<9)
  }
}

fiscal.yr<-function(year, month)
{
  year <- year + ifelse(month>=9,1,0)
}
fiscal.year<-function(recs)
{
  fiscal.yr(recs$year, recs$month)
}
fiscal.month<-function(recs)
{
  recs$month + ifelse(recs$month>=9, -9, +3)
}
```

EXAMPLES of how to adjust date columns:
names(all.charges) <- make.names(colnames(all.charges))
tmp<-as.POSIXlt(all.charges$Timecard.Start)
all.charges <- all.charges %>% mutate(year=tmp$year-100+2000,month=tmp$mon)

unlist(as.POSIXlt(all.charges$Timecard.End[5001]))
sec   min  hour  mday   mon  year  wday  yday isdst 
  0     0     0    22     4   122     0   141     0 
  

```{r}
datepart<-'Dec2022FY24Scenario'
datepart<-'Dec2022FY24ScenarioUpdated' # with delayed M&S
datepart<-'Dec2022FY23' # limited to 5.4M spending
#datepart<-'Dec2022StatusInput'
#datapart<-'Dec2022Current'
datepart<-'Dec22WSCurrent'

read.my.file <- function(datepart, tab)
{
  fname<-paste('extracted/tab_',tab,'_',datepart,'.csv',sep='')
  df <- read.csv(fname)
  df
}

adjust.date <- function(tab, col,ending) 
{ 
  name.s <- paste(col,"_start",ending,sep='')
  name.e <- paste(col,"_end",ending,sep='')
  tab[[name.s]] <- as.Date(tab[[name.s]]) 
  tab[[name.e]] <- as.Date(tab[[name.e]]) 
  tab
}

# these come from XER extractor
taskrsrc<-read.my.file(datepart, 'TASKRSRC')
rsrc<-read.my.file(datepart, "RSRC")
wbs<-read.my.file(datepart, "PROJWBS")
tasks<-read.my.file(datepart,"TASK")
# this is a summary of the above out of reader.py -P -d
all.data<-read.csv(paste("output/alltasks_",datepart,".csv",sep=''))
all.paths<-read.csv(paste("output/allareas_",datepart,".csv",sep=''))
all.data<-adjust.date(all.data,"target","")
all.data<-adjust.date(all.data,"early","")
all.data<-adjust.date(all.data,"late","")

```

```{r}
path.data <- left_join(all.paths, all.data, by=join_by(code))
```


Sequence is 
Find line in TASKRSRC, first two columns are IDs: taskrsrc_id, task_id
Find task_id in TASK: there is a task ID and task name here, and task_id,proj_id,wbs_id.
Find wbs_id in PROJWBS: the name of this area is found here

```{r}
#view(all.data%>%select(name, wbs, category, group, wbs_high, wbs_low))

tmp<-filter(path.data, year(target_start)>2021 & type!='Q' & wbs!='01.01')
tmp$g=as.numeric(as.factor(tmp$group))
tmp$a=as.numeric(as.factor(tmp$area))
tmp$p=as.numeric(as.factor(tmp$path))

# started with label=code
# y_discrete = "group"
# y = group
# ymin = g, ymax = g+.8
gp<-ggplot(tmp, aes(xmin = as.Date(target_start), xmax = as.Date(target_end), 
                   y=as.factor(path),# ymin = g, ymax = g+.8, 
                   fill = category)) +
  geom_rect(aes(ymin = p, ymax = p+.8)) +
  scale_y_discrete("path") +
  scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90)) + 
  geom_text(aes(x = as.Date(target_start), label = wbs), nudge_x=39.6, nudge_y=.2, size=3)#, check_overlap = TRUE)

ggsave(gp, filename="vs.pdf",units="in", height=10, width=24, device="pdf")
print(gp)
```

```{r}
sched <- tasks %>% left_join(wbs, by=join_by(wbs_id)) %>% select( task_id, target_start_date, target_end_date, task_code, task_name, wbs_id, wbs_name, wbs_short_name) %>% arrange(target_start_date)
```


```{r}
costs <- filter(taskrsrc,target_cost>0) %>% left_join(tasks,by=join_by(task_id))%>%left_join(wbs, by=join_by(wbs_id)) %>% select( task_id, target_cost, cost_per_qty, target_start_date.x, target_end_date.x, task_code, task_name, wbs_id, wbs_name, wbs_short_name) %>% arrange(target_start_date.x)
#view(costs)
```


```{r}
group.cat <- ggplot(all.data,aes(x=group, y=category)) + theme(axis.text.x = element_text(angle = 90)) + geom_count()
group.area <- ggplot(all.data,aes(x=group, y=wbs_high)) + theme(axis.text.x = element_text(angle = 90)) + geom_count()
cat.area <- ggplot(all.data,aes(x=category, y=wbs_high)) + theme(axis.text.x = element_text(angle = 90)) + geom_count()
print(group.cat)
print(group.area)
print(cat.area)
```

```{r}
stop.code.list <- read.csv("input/code_list.csv",header=TRUE)
```

The lines that are wrong values are:

179259425 A1701AA10   rsrc_type = RT_Equip for the 240 in taskrsrc
179259423 A1701N10    Same thing is true for this one, for the 240

X Now task_id 179259445 is missing!!! (value of 60 hours) task_code A1803770

A1802700 is missing
A1803460 seems to be missing
A1803770 is missing


```{r}
# get all the tasks that match our task_code
stopped.tasks <- left_join(stop.code.list, tasks, by=join_by(task_code)) %>% select(task_id, task_code, target_work_qty,rsrc_id, task_name)

# get all the taskrsrc records that match our task_id
stopped.taskrsrc <- left_join(stopped.tasks, filter(taskrsrc,rsrc_type=='RT_Labor'),multiple='all', by=join_by(task_id)) %>% select(task_id, task_code, rsrc_id.x, rsrc_id.y, target_qty, target_work_qty, rsrc_type)

stopped.rsrcs <- stopped.taskrsrc %>% left_join(filter(rsrc,rsrc_type=='RT_Labor'),by=join_by(rsrc_id.y==rsrc_id)) %>% select(task_id, task_code, rsrc_name, rsrc_id.y, target_qty, target_work_qty, rsrc_name, rsrc_type.x) %>% filter(!is.na(target_qty))


hours.sum <-select(stopped.rsrcs,rsrc_id.y,task_code,rsrc_name,target_qty) %>% group_by(rsrc_name) %>% summarise(total.hours=sum(target_qty))

```


```{r}
alltask.lv <-read_excel("output/alltasks LV edit.xlsx") 
alltask.lv <- select(alltask.lv, code, category, group, 'New Category', 'New Group', 'Label Type', LABEL) %>% arrange(code)
names(alltask.lv)<-c('code','old.category','old.group','new.category','new.group','label.type','label')

new.ones.grp<-!is.na(alltask.lv$new.group)
new.ones.cat<-!is.na(alltask.lv$new.category)
alltask.lv<-mutate(alltask.lv, category=alltask.lv$old.category, group=alltask.lv$old.group)
alltask.lv$category[new.ones.cat]<-alltask.lv$new.category[new.ones.cat]
alltask.lv$group[new.ones.grp]<-alltask.lv$new.group[new.ones.grp]
```

reports for 
What activities are ongoing now? -> now within [start, end]
What was supposed to start? -> status==TK_NotStart  and planned_start < now
What was supposed to end? -> status==started and planned_end < now
What is coming up next? -> status==not started and planned_start within [now, now+1 month]

What has been active for >6 months
What has a gap between target start and late start of greater than X months?
What has a gap between target end and late end of greater than X months?


```{r}
now <- Sys.Date()
target <- interval(all.data$target_start, all.data$target_end)
active <- all.data[now %within% target,] %>% arrange(desc(target_start))
no.start <- all.data %>% filter(status=='TK_NotStart' & target_start<now)
should.end <- all.data %>% filter(status=='TK_Active' & target_end<now)
up.next <- all.data %>% filter(status=='TK_NotStart' & target_start %within% interval(now,now+months(1)))
start.gap <- all.data %>% filter((late_start-target_start)>months(9))
end.gap <- all.data %>% filter((late_end-target_end)>months(9))
```


```{r}
gp<-ggplot(active%>%filter(target_start<as.Date("2026-10-01")), aes( 
                   y=reorder(code,target_start))) +
  geom_linerange(aes(xmin = early_start, xmax = early_end),colour='red',position=position_nudge(y=0.0)) +
  geom_linerange(aes(xmin = late_start, xmax = late_end), colour='green',position=position_nudge(y=0.0)) +
  geom_linerange(aes(xmin = target_start, xmax = target_end), colour='blue', linewidth=1.0) +
  geom_text(aes(x = target_start, label = name), nudge_x=9.6, nudge_y=.4, size=1) +
  geom_text(aes(x = late_end, label = paste(free_float, total_float, sep='/')), nudge_x=9.6, nudge_y=.4, size=1) +
  #geom_point(aes(x=now)) +
  #scale_y_discrete("code") +
  scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90),axis.text=element_text(size=8)) #+ 
print(gp)

ggsave(gp, filename="active.pdf",units="in", height=10, width=24, device="pdf")

```
```{r}
tmp<-select(active,code)[,1]
tmp2<-tasks[(tasks$task_code %in% tmp),]
tmp2.1<-tmp2 %>% filter((target_drtn_hr_cnt-remain_drtn_hr_cnt)==0 ) %>% select(task_code, remain_drtn_hr_cnt, target_drtn_hr_cnt, task_name)

```


```{r}
gp2<-ggplot(active%>%filter(area>10|area==1), 
            aes( colour=as.factor(area), y=reorder(code,target_start))
            ) +
  geom_linerange(aes(xmin = target_start, xmax = target_end), linewidth=1.0)+ #, colour='blue') +
  #scale_y_discrete("code") +
  scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90),axis.text=element_text(size=8)) #+ 
print(gp2)
ggsave(gp2, filename="active2.pdf",units="in", height=10, width=24, device="pdf")
```

```{r}
gp3<-ggplot(all.data%>%filter(type=='M'), 
            aes( colour=as.factor(area), y=reorder(code,target_start))
            ) +
  geom_linerange(aes(xmin = target_end, xmax = late_end), linewidth=.10)+ #, colour='blue') +
  #geom_point(aes(x=late_end)) +
  geom_point(aes(x=target_end)) +

  #scale_y_discrete("code") +
  scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90),axis.text=element_text(size=8)) #+ 
print(gp3)
ggsave(gp3, filename="milestones.pdf",units="in", height=10, width=24, device="pdf")
```
