---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=TRUE}
library(tidyverse)
library(ggplot2)
library(readxl)
library(writexl)
library(stringr)
library(lubridate)

library(MAGIS100PM)
```


This is a comparison between two schedules

all <- get.all.schedule("current")
charges <- get.all.kronos()
people <- get.p6.people(charges, all)
tasks.people <- combine.tasks.people(people, all)


```{r}
current <- get.all.schedule("current")
working <- get.all.schedule("WS2309") # first
bcrs<- get.all.schedule("BLBCR") # other

charges <- get.all.kronos()

all.current<- current$all.data
all.working<- working$all.data
all.bcrs<- bcrs$all.data

exp.curr <- bin.expenses(all.current)
exp.work <- bin.expenses(all.working)
exp.bcrs <- bin.expenses(all.bcrs)

sum.curr<- exp.curr$target.by.week%>% group_by(FY) %>% summarise(tot_tc=sum(hsum, na.rm=TRUE))
sum.work<- exp.work$target.by.week%>% group_by(FY) %>% summarise(tot_tc=sum(hsum, na.rm=TRUE))
sum.bcrs<- exp.bcrs$target.by.week%>% group_by(FY) %>% summarise(tot_tc=sum(hsum, na.rm=TRUE))

sum.both<- full_join(sum.work, sum.bcrs, by=join_by(FY),suffix=c(".curr",".BCRs")) %>% mutate(diff=tot_tc.BCRs-tot_tc.curr)
view(sum.both)

sum.both %>% summarise(x=sum(tot_tc.curr),y=sum(tot_tc.BCRs))
```

```{r}
reduce.cols <- function(x) {
  x %>% select(code, name, actual_start, actual_end, target_start, target_end, total_cost, total_float, dur)
}

bcrs.curr <- full_join(reduce.cols(all.current), reduce.cols(all.bcrs), by=join_by(code),suffix=c(".cur",".BCR"))
bcrs.work <- full_join(reduce.cols(all.working), reduce.cols(all.bcrs), by=join_by(code),suffix=c(".cur",".BCR"))

bcrs.curr <- bcrs.curr%>% mutate(cost.diff=total_cost.BCR-total_cost.cur, 
                                 float.diff=total_float.BCR-total_float.cur,
                                 actual.diff=target_start.BCR-actual_start.cur,
                                 target.diff=target_start.BCR-target_start.cur
                                 ) #%>% filter(cost.diff!=0 | target.diff!=days(0))
bcrs.work <- bcrs.work%>% mutate(cost.diff=total_cost.BCR-total_cost.cur, 
                                 float.diff=total_float.BCR-total_float.cur,
                                 actual.diff=target_start.BCR-actual_start.cur,
                                 target.diff=target_start.BCR-target_start.cur
                                 ) #%>% filter(cost.diff!=0 | target.diff!=days(0))

write_xlsx(bcrs.work, "WS_BCR.xlsx")
write_xlsx(bcrs.curr, "BL_BCR.xlsx")

#view(bcrs.curr)
view(bcrs.work)
```

```{r}

tmp.both<- left_join(all.current, all.working, by=join_by(code),suffix=c(".BL2307",".WS2309"))

tmp.diff<- tmp.both %>% 
  select(code, name.BL2307, dur.BL2307, dur.WS2309, 
         target_start.BL2307, target_start.WS2309, target_end.BL2307, target_end.WS2309, 
         late_start.BL2307, late_start.WS2309, late_end.BL2307, late_end.WS2309, 
         total_float.BL2307, total_float.WS2309, 
         total_cost.BL2307, total_cost.WS2309, cost.WS2309, cost.BL2307,  
         wbs.BL2307, group.BL2307,category.BL2307) %>% 
  mutate(dur.diff=dur.BL2307-dur.WS2309,
         float.diff=total_float.BL2307-total_float.WS2309,
         tot.cost.diff=total_cost.BL2307-total_cost.WS2309, 
         dd.task=dur.BL2307==dur.WS2309*2,
         FY.BL2307=fiscal.from.date(target_start.BL2307),
         FY.WS2309=fiscal.from.date(target_start.WS2309)
         )
sum.by.fy<- left_join(
  tmp.diff%>% group_by(FY.BL2307)%>%summarise(tot=sum(total_cost.BL2307,na.rm=TRUE)),
  tmp.diff%>% group_by(FY.WS2309)%>%summarise(tot=sum(total_cost.WS2309,na.rm=TRUE)),
  by=join_by(FY.BL2307==FY.WS2309)) %>%
    mutate(dif=tot.y-tot.x)

tmp.filtered<- tmp.diff %>% 
#  filter((target_start.BL2307 %within% fuller.interval | target_end.BL2307 %within% fuller.interval)) %>%
  mutate(end.diff=target_end.BL2307 - target_end.WS2309,
         start.diff=target_start.BL2307 - target_start.WS2309) 

#%>% filter(dur.x!=0)

write_xlsx(tmp.filtered, "differences.xlsx")

#tmp.filtered %>% filter((target_start.cur %within% FY24.interval | target_end.cur %within% FY24.interval)) %>% summarise(tcost=sum(total_cost.cur))
```

#```{r}
user_field_10040.id <- (filter(other$udf.type, udf_type_name=='user_field_10040') %>% select(udf_type_id))[[1]]
uncertainty.recs <- filter(other$udf.value, udf_type_id==user_field_10040.id) %>% select(task_id=fk_id, uncertainty=udf_text)
# this needs to be paired up with taskrsrc for matching IDs
tmptmp<- left_join(other$taskrsrc, uncertainty.recs, by=join_by(taskrsrc_id==task_id))
 
#```



view I'm using to analyze this
```{r}
# all.other.save <- all.other
# sum.both.save <- sum.both
#view(all.other %>% mutate(yr=fiscal.from.date(target_start)) %>% select(code, name, target_start, target_end, total_float, total_cost,yr)%>%arrange(yr,total_float))

view(all.other %>% mutate(yr=fiscal.from.date(target_start), days_float=total_float/8) %>% select(code, name, target_start, target_end, total_float, total_cost,yr, days_float)%>%arrange(target_start))
```

```{r}
#hrs.prj<- read_xlsx("../finance/ETD Project Labor Report 2023-12-SEP 2023.10.04.xlsx", sheet="Sheet1")
#hrs.prj<-hrs.prj%>%pivot_longer(2:15)%>%filter(!is.na(value) & !name=="...15")
hrs.prj<- read_xlsx("../finance/ETD Project Labor Report 2023-12-SEP 2023.10.04.xlsx", sheet="Project Hours", skip=5)
hrs.bud<- read_xlsx("../finance/ETD Project Labor Report 2023-12-SEP 2023.10.04.xlsx", sheet="Budget vs Actual Hours", skip=4)
names(hrs.bud) <- c("name","budget.hours","actual.hours", "blob", "variance", "EOC")
hrs.ctc <- hrs.bud %>%filter(str_detect(name, "Q1903"))
#hrs.bud<-hrs.bud%>%pivot_longer(2:15)%>%filter(!is.na(value) & !name=="...15")
```

