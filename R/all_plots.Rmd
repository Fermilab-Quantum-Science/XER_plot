---
title: "R Notebook"
output: html_notebook
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(readxl)
library(writexl)
library(stringr)
library(rlang)
library(lubridate)

library(MAGIS100PM)
```

library(reticulate)
Sys.setenv(RETICULATE_PYTHON = "/Users/jimk/AppData/Local/Microsoft/WindowsApps/PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0")
use_python("/Users/jimk/AppData/Local/Microsoft/WindowsApps/PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0", required=TRUE)

#```{python}
#print("the")
#python.exe xer_extractor.py -x current
#python.exe reader.py -d -x current -S
#```


```{r}
#all <- get.all.schedule("BLBCR")
all <- get.all.schedule("WS2309")
charges <- get.all.kronos()
people <- get.p6.people(charges, all)
tasks.people <- combine.tasks.people(people, all)
```

```{r}
labor <- bin.labor(tasks.people)
costs <- bin.expenses(all$all.data)
costs.week <- costs$target.by.week%>% filter(FY>=2023&FY<2028)%>%group_by(FY)%>%mutate(csum=cumsum(hsum))
```


```{r}
fte<- FTE.plots(labor$by.day.all%>%filter(code!='other'))
activities<- activities.plot(all$all.data, start.date=as.Date('2023-08-01'),end.date=as.Date('2023-12-01'))
milestones<- milestones.plot(all$all.data)
resources<- resources.plot(labor$by.week, device="png")
proc<- procurements.plot(all, en=Sys.Date()+weeks(8*4))
reviews<- reviews.plot(all$all.data)
```

```{r}
ggsave(resources, filename=paste(base.path,"/hours.png",sep=''), width=24, units='in', device='png')
ggsave(milestones, filename=paste(base.path,'/milestones.png',sep=''), width=11, units='in', device="png")
ggsave(activities, filename=paste(base.path,"/active.pdf",sep=''),width=11, units="in", device="pdf")
ggsave(reviews, filename=paste(base.path,"/reviews.pdf",sep=''),units="in", width=11, device="pdf")
ggsave(proc$plot, filename=paste(base.path,"/procurements.pdf",sep=''),units="in", width=16, device="pdf")
ggsave(fte[[1]], filename=paste(base.path,"/fte_role.png",sep=''),units="in", device="png")
ggsave(fte[[2]], filename=paste(base.path,"/fte_div.png",sep=''),units="in", device="png")

```


```{r}
print(proc$plot)
print(milestones)
#print(fte[[1]])
#print(fte[[2]])
#print(fte[[3]])
#print(fte[[4]])
print(resources)
print(activities)
print(reviews)
```

#```{r}
#activities<- activities.plot(all$all.data, interval(as.Date('2024-09-01'),as.Date('2025-11-01')),tcost=1)
#```

```{r}
#labor <- bin.labor(tasks.people)

persons.FY23Q34<- labor$by.week.person %>%
  filter(FY==2023)%>%
  filter(week %within% interval('2023-07-01','2023-10-01')) %>%
  group_by(person,FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805/4)) %>%
  filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name, div=DSC),join_by(person) )

persons.FY2324<- labor$by.week.person %>%
  filter(FY %in% c(2023,2024)) %>%
  group_by(person,FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805)) %>%
  filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name),join_by(person) )
write_xlsx(persons.FY2324, "persons_FY2324.xlsx")

types.FY2324<- labor$by.week.all %>%
  filter(FY %in% c(2023,2024)) %>%
  group_by(type,person, FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805)) %>%
  #filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name, DSC),join_by(type,person) )
write_xlsx(types.FY2324, "types_FY2324.xlsx")

tpt.FY<- labor$by.week.person.task %>%
  filter(FY>2022) %>%
  group_by(type,person,task_id, FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805)) %>%
  #filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name, DSC),join_by(type,person)) %>%
  left_join(all$tasks%>%select(task_id, task_name, task_code, target_start_date, target_end_date), by=join_by(task_id))
write_xlsx(tpt.FY%>% filter(FY %in% c(2023,2024)), "TPT_FY23_24.xlsx")


```

This block below is all special code that really only needs to be run once or for testing.

```{r}
#all$all.data %>% 
#  mutate(yr=fiscal.from.date(target_start), days_float=total_float/8) %>%
#  filter(yr>2023) %>%
#  select(code, name, target_start, target_end, total_float, total_cost,yr, days_float) %>%
#  arrange(target_start) %>%
#  view()

# prime the rolesmap here (only needed once, then hand edited)
#rolesmap<-rbind(
#  data.frame(role=unique(charges$Function.Role))%>%mutate(type='kr'),
#  data.frame(role=unique(labor$by.week.person$type))%>%mutate(type='p6')
#)
#write_xlsx(rolesmap,"../rolesmap.xlsx")

#ctcmap<- read.csv("../ctcmap.csv",colClasses=c("character","character","character"), strip.white=TRUE)
#save(ctcmap, file="../MAGIS100PM/data/ctcmap.rda",version=2)

#rolesmap<- read_xlsx("../rolesmap.xlsx")
#save(rolesmap, file="../MAGIS100PM/data/rolesmap.rda",version=2)

#roles<- read.csv("../roles.csv", strip.white=TRUE)
#save(roles, file="../MAGIS100PM/data/roles.rda",version=2)


```

Full.Name = Full.Name
Full.Name = Role

```{r}
kr.proc <- function(grouping.name, charges)
{
  grouping.sym = rlang::sym(grouping.name)

  kr.tmp<- charges %>% filter(Timecard.Start>as.Date("2023-03-01")) %>%
    select(FY=fiscal.year, d=Timecard.Start, Hours=Hours, Full.Name=Full.Name,ctc=taskcode,department=DSC, role=Role) %>%
    mutate(LOE=ctc=='Q1903.01') %>%
    mutate(role.new=if_else(LOE=='TRUE'&!is.na(ctc), "LOE", role))

  kr.tmp.1<- kr.tmp%>% group_by(ctc, !!grouping.sym, d) %>% summarise(sum=sum(Hours),.groups='keep')
  kr.tmp.2<- kr.tmp.1%>% arrange(ctc, !!grouping.sym, d) %>% group_by(ctc, !!grouping.sym) %>% mutate(csum=cumsum(sum))
  kr.tmp.1<- rename(kr.tmp.1, grouping=grouping.name)
  kr.tmp.2<- rename(kr.tmp.2, grouping=grouping.name)

  kr.tmp.g1<- ggplot(kr.tmp.1,aes(x=d, y=sum)) + geom_step() + facet_wrap(vars(ctc,grouping),scales="free_y")
  kr.tmp.g2<- ggplot(kr.tmp.2,aes(x=d, y=csum)) + geom_step() + facet_wrap(vars(ctc,grouping),scales="free_y")

  list(kr=kr.tmp, kr1=kr.tmp.1, kr2=kr.tmp.2, kr.g1=kr.tmp.g1, kr.g2=kr.tmp.g2)
}

p6.proc <- function(grouping.name, labor.by.week)
{
  grouping.sym = rlang::sym(grouping.name)
  
  p6.tmp<- labor.by.week %>% filter(week>=as.Date("2023-03-01")&week<=as.Date("2024-01-01")) %>%
    select(FY=FY, d=week, Hours=dl.hours, Full.Name=person, department=code, ctc=ctc, role=Role) %>%
    mutate(LOE=ctc=='Q1903.01')%>%
    mutate(role.new=if_else(LOE=='TRUE'&role!="RA", "LOE", role))

  p6.tmp.1<- p6.tmp %>% group_by(ctc, !!grouping.sym, d) %>% summarise(sum=sum(Hours),.groups='keep')
  p6.tmp.2<- p6.tmp.1%>% arrange(ctc, !!grouping.sym, d) %>% group_by(ctc, !!grouping.sym) %>% mutate(csum=cumsum(sum))
  p6.tmp.1<- rename(p6.tmp.1, grouping=grouping.name)
  p6.tmp.2<- rename(p6.tmp.2, grouping=grouping.name)

  p6.tmp.g1<- ggplot(p6.tmp.1,aes(x=d, y=sum)) + geom_step() + facet_wrap(vars(ctc,grouping),scales="free_y")
  p6.tmp.g2<- ggplot(p6.tmp.2,aes(x=d, y=csum)) + geom_step() + facet_wrap(vars(ctc,grouping),scales="free_y")
  
  list(p6=p6.tmp, p61=p6.tmp.1, p62=p6.tmp.2, p6.g1=p6.tmp.g1, p6.g2=p6.tmp.g2)
}

```

Full.Name = person
Full.Name = Role

labor$by.week.person
labor$by.week.role


```{r}

#kr.data <- kr.proc("role.new", charges%>%filter(taskname=="Q1903.10"))
kr.data <- kr.proc("role.new", charges)
p6.data <- p6.proc("role.new", labor$by.week.ctc) # role
```


#```{r}
print(kr.data$kr.g1)
print(kr.data$kr.g2)

ggsave(kr.data$kr.g1, filename=paste(base.path,"/HoursByName.pdf",sep=''),units="in", height=12, width=24, device="pdf")
ggsave(kr.data$kr.g2, filename=paste(base.path,"/CumuHoursByName.pdf",sep=''),units="in", height=12, width=24, device="pdf")
# ```

#```{r}
print(p6.data$p6.g1)
print(p6.data$p6.g2)

ggsave(p6.data$p6.g1, filename=paste(base.path,"/P6HoursByName.pdf",sep=''),units="in", height=12, width=24, device="pdf")
ggsave(p6.data$p6.g2, filename=paste(base.path,"/P6CumuHoursByName.pdf",sep=''),units="in", height=12, width=24, device="pdf")

#```

```{r}
#person.diff <- setdiff(unique(charges$Full.Name), unique(labor$by.week.person$person))
person.comp <- rbind(mutate(p6.data$p62,from="P6"),mutate(kr.data$kr2,from="KR"))
  #left_join(mutate(tmp.2,from="KR"), by=join_by(Full.Name,d), suffix=c(".p6",".kr"))

person.g3<- ggplot(person.comp,aes(x=d, colour=from)) + 
  geom_step(aes(y=csum)) +
  geom_step(aes(y=csum)) +
  facet_wrap(vars(ctc,grouping),scales="free_y")

print(person.g3)
ggsave(person.g3, filename=paste(base.path,"/CumuHoursByRole.pdf",sep=''),units="in", height=12, width=24, device="pdf")

tmp<- person.comp %>% ungroup() %>% select(from, d, isum=sum) %>% group_by(from,d)%>% summarise(sum=sum(isum)) %>% arrange(from, d) %>% group_by(from) %>% mutate(csum=cumsum(sum))

person.g4<- ggplot(tmp,aes(x=d, colour=from)) + 
  geom_step(aes(y=csum))# +
#  geom_step(aes(y=csum)) +
#  facet_wrap(vars(from),scales="free_y")
print(person.g4)
```
```{r}
ctc.comp <- rbind(mutate(p6.data$p6,from="P6"),mutate(kr.data$kr,from="KR"))

tmp<- ctc.comp %>% ungroup() %>% select(from, FY, ctc, d, Hours) %>% group_by(FY,from,ctc,d)%>% summarise(sum=sum(Hours)) %>% arrange(FY, from, ctc, d) %>% group_by(FY, from, ctc) %>% mutate(csum=cumsum(sum))

ctc.g5<- ggplot(tmp,aes(x=d, colour=from)) + 
  geom_step(aes(y=csum)) +
#  geom_step(aes(y=csum)) +
  facet_wrap(vars(FY,ctc),scales="free_y")
print(ctc.g5)

tmp2<- ctc.comp %>% ungroup() %>% select(from, FY, name=role.new, d, Hours) %>% group_by(FY,from,name,d)%>% summarise(sum=sum(Hours)) %>% arrange(FY, from, name, d) %>% group_by(FY, from, name) %>% mutate(csum=cumsum(sum))

person.g6<- ggplot(tmp2,aes(x=d, colour=from)) + 
  geom_step(aes(y=csum)) +
#  geom_step(aes(y=csum)) +
  facet_wrap(vars(FY,name),scales="free_y")
print(person.g6)


```

```{r}
# costs.week%>%filter(FY==2024 & csum>1000000)%>% slice(1)
costs.g5<- ggplot(costs.week%>% filter(FY==2024),
                  aes(x=week)) + 
  geom_step(aes(y=csum))+
  #geom_vline(aes(xintercept=costs.week%>%filter(FY==2024&csum>1300000)%>%slice(1)%>%pull(week)))+
  #geom_hline(aes(yintercept=costs.week%>%filter(FY==2024&csum>1300000)%>%slice(1)%>%pull(csum)))+
  scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90),axis.text=element_text()) +
  labs(x="Week", y="dollars")

print(costs.g5)

```

```{r}
k<- kr.proc("Full.Name", charges)
tmpp<- ggplot(k$kr2, aes(x=d, colour=ctc)) + geom_step(aes(y=csum)) + facet_wrap(vars(grouping), scales="free_y", ncol=4)
ggsave("./kr2_cyc.pdf", tmpp)
print(tmpp)
```

```{r}
fquarter<- function(x) { quarter(x, fiscal_start=10, type="date_first") }
lquarter<- function(x) { quarter(x, fiscal_start=10, type="date_last") }
quarter(Sys.Date()+months(1), fiscal_start = 10, type="year.quarter")
quarter("2023-07-07", fiscal_start = 10, type="date_first")
tmp.df<- fquarter(Sys.Date())
tmp.dl<- lquarter(Sys.Date())
print(tmp.df)
print(tmp.dl)

fquarter(tmp.df-months(1))
fquarter(tmp.dl+months(1))

floor_date(as.Date("2023-11-04"), unit="month")-months(1)
```

```{r}

costs.by.month <- costs$target.by.day %>%
  mutate(month=floor_date(week,unit="month",week_start=1)) %>%
    group_by(FY, month) %>% summarise(msum=sum(hsum,na.rm=TRUE),.groups='drop')

t.by.day<- unnest(costs$target.day.grouped,cols=c(dl),names_sep='.') %>% arrange(s) %>%
    mutate(week=floor_date(dl.d,unit="week",week_start=1)) %>%
    mutate(FY.orig=fiscal.from.date(week), FY=fiscal.date.adjust(week,FY.orig)) %>%
    group_by(FY, ctc, week) %>% summarise(hsum=sum(dl.hours,na.rm=TRUE),.groups='drop') %>%
    mutate(month=floor_date(week,unit="month",week_start=1)) %>%
    group_by(FY, ctc, month) %>% summarise(msum=sum(hsum,na.rm=TRUE),.groups='drop')
t.by.month <- t.by.day %>% 
  arrange(FY, ctc, month) %>% group_by(FY, ctc) %>% mutate(cumu=cumsum(msum))

ggplot(t.by.month%>%filter(FY==2023), aes(x=month, y=cumu,colour=ctc))+
        scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
        geom_point() + geom_step()
```

This is the actuals spreadsheet that ETD sends out each month with updated values for the year.
I had to edit the spreadsheet to add a column name for taskcode.
```{r}
tmp<- read_xlsx("../../finance/SV_Q1903_2024-01 OCT_Costs by Month_20231106.xlsx", n_max=7, col_names=FALSE)
tmp.2<- read_xlsx("../../finance/SV_Q1903_2024-01 OCT_Costs by Month_20231106.xlsx", skip=7, col_names=FALSE)
names(tmp.2)<- paste(slice(tmp,7),slice(tmp,1),sep='.')
tmp<- tmp.2 %>% pivot_longer(-NA.Task.code)
tmp.3<- str_split(tmp$name, "\\.",simplify=TRUE)
tmp$month<- tmp.3[,1]
tmp$fyear<- as.numeric(str_sub(tmp.3[,2],start=3))+2000
tmp$date<- rollforward(my(paste(tmp$month,tmp$fyear,sep='.')))
tmp$date<- if_else(month(tmp$date)>=10,tmp$date-years(1),tmp$date)
tmp$taskcode.orig<- as.data.frame(str_split(tmp$NA.Task.code, "[\\._]",simplify=TRUE, n=4))%>% select(V2,V3) %>% mutate(taskcode=paste(V2,V3,sep='.'))%>%pull(3)
tmp<- tmp%>% left_join(MAGIS100PM::taskcodemap, by=join_by(taskcode.orig))
tmp.4<- tmp%>%filter(!is.na(taskcode)&date<as.Date('2023-10-01'))%>%arrange(taskcode,date) %>% group_by(taskcode,date) %>% summarise(total=sum(value)) %>% mutate(cumu=cumsum(total))

print(ggplot(tmp.4, aes(x=date, y=total, colour=taskcode))+
        scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
        geom_point() + geom_line())
print(ggplot(tmp.4, aes(x=date, y=cumu, colour=taskcode))+
        scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
        geom_point() + geom_step())
```
