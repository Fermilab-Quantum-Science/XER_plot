---
title: "R Notebook"
output: html_notebook
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(readxl)
library(writexl)
library(stringr)
library(rlang)
library(lubridate)

library(MAGIS100PM)
```


```{r}
#all <- get.all.schedule("BL2307")
#all <- get.all.schedule("BL2309")
all.orig <- get.all.schedule("WS2309")
# note: if using WS schedule, the target dates need to be adjusted using the baseline
all <- apply.baseline.schedule(all.orig, "BCRBL2")

charges <- get.all.kronos()
people <- get.p6.people(charges, all)
tasks.people <- combine.tasks.people(people, all)

```

```{r}
labor <- bin.labor(tasks.people)
costs <- bin.expenses(all$all.data)
costs.week <- costs$target.by.week%>% filter(FY>=2023&FY<2028)%>%group_by(FY)%>%mutate(csum=cumsum(hsum))
```


```{r}
fte<- FTE.plots(labor$by.day.all%>%filter(code!='other'))
activities<- activities.plot(all$all.data, start.date=as.Date('2023-03-01'),end.date=as.Date('2023-12-01'))
milestones<- milestones.plot(all$all.data)
resources<- resources.plot(labor$by.week, device="png")
proc<- procurements.plot(all, en=Sys.Date()+weeks(8*4))
reviews<- reviews.plot(all$all.data)
```

```{r}
ggsave(resources, filename=paste(base.path,"/output/hours.png",sep=''), width=24, units='in', device='png')
ggsave(milestones, filename=paste(base.path,'/output/milestones.png',sep=''), width=11, units='in', device="png")
ggsave(activities, filename=paste(base.path,"/output/active.pdf",sep=''),width=12, height=10, units="in", device="pdf")
ggsave(reviews, filename=paste(base.path,"/output/reviews.pdf",sep=''),units="in", width=11, device="pdf")
ggsave(proc$plot, filename=paste(base.path,"/output/procurements.pdf",sep=''),units="in", width=16, device="pdf")
ggsave(fte[[1]], filename=paste(base.path,"/output/fte_role.png",sep=''),units="in", device="png")
ggsave(fte[[2]], filename=paste(base.path,"/output/fte_div.png",sep=''),units="in", device="png")

```


```{r}
print(proc$plot)
print(milestones)
#print(fte[[1]])
#print(fte[[2]])
#print(fte[[3]])
#print(fte[[4]])
print(resources)
print(activities)
print(reviews)
```

#```{r}
#activities<- activities.plot(all$all.data, interval(as.Date('2024-09-01'),as.Date('2025-11-01')),tcost=1)
#```


This is a test for plotting over the T2 milestones
```{r}
milestones<- milestones.filter(all$all.data%>%filter(str_detect(name,"T2 ")),exclude.future=FALSE)

gp3<-ggplot(
    milestones,
    aes( colour=  state, y=reorder(code,target_start))
  ) +
    geom_linerange(aes(xmin = target_end, xmax = late_end), linewidth=.10)+ #, colour='blue') +
    geom_point(aes(x=target_end),size=2) +
    geom_text(aes(hjust='left',x = target_end, label = short_name), nudge_x=9.6, nudge_y=.4) +
    geom_text(aes(hjust='right',x=as.Date(max(late_end))+months(3), label = paste(total_float, sep='/')),
              nudge_y=.4, check_overlap = TRUE) +
    scale_x_date(date_breaks='1 month', date_labels = "%b %y") +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(x="Target End Date", y="Milestone", colour="State")

ggsave(gp3, filename=paste(base.path,'/output/milestones.pdf',sep=''), width=14, height=10, units='in', device="pdf")
#print(gp3)

```


