---
title: "R Notebook"
output: html_notebook
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(readxl)
library(writexl)
library(stringr)
library(rlang)
library(lubridate)

library(MAGIS100PM)
```


```{r}
#all <- get.all.schedule("BLBCR")
all <- get.all.schedule("WS2309")
all <- apply.baseline.schedule(all, "BCRBL2")
charges <- get.all.kronos()
people <- get.p6.people(charges, all)
tasks.people <- combine.tasks.people(people, all)
```

```{r}
labor <- bin.labor(tasks.people)
costs <- bin.expenses(all$all.data)
costs.week <- costs$target.by.week%>% filter(FY>=2023&FY<2028)%>%group_by(FY)%>%mutate(csum=cumsum(hsum))
```



```{r}
#labor <- bin.labor(tasks.people)

persons.FY23Q34<- labor$by.week.person %>%
  filter(FY==2023)%>%
  filter(week %within% interval('2023-07-01','2023-10-01')) %>%
  group_by(person,FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805/4)) %>%
  filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name, div=DSC),join_by(person) )

persons.FY2324<- labor$by.week.person %>%
  filter(FY %in% c(2023,2024)) %>%
  group_by(person,FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805)) %>%
  filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name),join_by(person) )
write_xlsx(persons.FY2324, paste(base.path,"persons_FY2324.xlsx",sep=''))

types.FY2324<- labor$by.week.all %>%
  filter(FY %in% c(2023,2024)) %>%
  group_by(type,person, FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805)) %>%
  #filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name, DSC),join_by(type,person) )
write_xlsx(types.FY2324, paste(base.path,"types_FY2324.xlsx",sep=''))

tpt.FY<- labor$by.week.person.task %>%
  filter(FY>2022) %>%
  group_by(type,person,task_id, FY)%>%
  summarise(hrs=sum(dl.hours)) %>% 
  mutate(ftes=hrs/(1805)) %>%
  #filter(!is.na(person)) %>%
  left_join(people%>%select(person=role_name, type=rsrc_name, DSC),join_by(type,person)) %>%
  left_join(all$tasks%>%select(task_id, task_name, task_code, target_start_date, target_end_date), by=join_by(task_id))
write_xlsx(tpt.FY%>% filter(FY %in% c(2023,2024)), paste(base.path,"output/TPT_FY23_24.xlsx",sep=''))


```

#req %>% distinct(Name) %>% pull() %>% str_split_i(", ",i=1) %>% toupper()
# use charges$Last.Name for join

#by.day.grouped<- tasks.with.all %>%
#    filter(rsrc_type.x=='RT_Labor') %>%
#    select( task_id=task_id,s=target_start_date, e=target_end_date, dt=target_qty, r=remain_qty,  person=role_name, #rsrc=rsrc.code, type=rsrc_name, code=DSC, ctc=ctc, Role=Role, Specialty=Specialty) %>%
    #filter(!is.na(ctc)&str_detect(ctc,".*")) %>%
#    rowwise() %>% mutate(dl=list(dates.list.days(s,e,dt)))

#  by.day<- unnest(by.day.grouped,cols=c(dl),names_sep='.') %>% arrange(s) %>%
#    mutate(week=ceiling_date(dl.d,unit="week",week_start=1)) %>%
#    mutate(FY.orig=fiscal.from.date(week), FY=fiscal.date.adjust(week,FY.orig))

charges%>%distinct(Function.Category) %>% view() # don't use
charges%>%distinct(Function.Role) %>% view() # role
charges%>%distinct(taskcode) %>% view() # ctc
req%>%distinct(ResourceRole) # role
req %>% distinct(ProjectTask) # ctc
labor$by.week.ctc %>% ungroup() %>% distinct(Role) # role
labor$by.week.ctc %>% ungroup() %>% distinct(ctc) # ctc



```{r}
filt.st<-as.Date("2023-07-01")
filt.en<-as.Date("2023-10-02")
filt.asof<- as.Date("2023-07-01")
filt.name<- "FY23Q4"

req <- read_xlsx("../input/LaborRequestFrom202306.xlsx")

req<- req %>% 
  mutate(start=as.Date("2023-10-01"), end=as.Date("2024-09-30"), hours.per.year=fermi.FTE*Request,
         Last.Name=toupper(str_split_i(Name,", ",i=1))
)

req.rows<- req %>% rowwise() %>% mutate(dl=list(dates.list.days(start,end,hours.per.year)))

req.by.day <- unnest(req.rows, cols=c(dl),names_sep='_') %>% arrange(start) %>%
  mutate(week=ceiling_date(dl_d, unit="week", week_start=1))

req.by.week <- req.by.day %>% filter(week>=filt.st & week<filt.en) %>%
  group_by(Last.Name, week) %>% summarise(hours=sum(dl_hours)) %>% 
  ungroup() %>% arrange(Last.Name, week) %>% group_by(Last.Name) %>%
  mutate(chours=cumsum(hours))


kro <- charges %>% filter(Timecard.Start>=filt.asof & Timecard.Start<filt.en) %>% 
  select(week=Timecard.Start,Timecard.End, Last.Name, Charged.Hours=Hours) %>% 
  group_by(Last.Name, week,Timecard.End) %>% summarize(hours=sum(Charged.Hours)) %>% ungroup() %>%
  arrange(Last.Name,week) %>% group_by(Last.Name) %>% 
  mutate(chours=cumsum(hours))

req.kro <- full_join(req.by.week%>%filter(week<=filt.en), kro, by=join_by(Last.Name, week), suffix=c(".budget",".kronos"))

# recalculate cumulative hours
req.kro <- req.kro %>% arrange(Last.Name, week) %>% group_by(Last.Name) %>%
  mutate(hours.kronos=if_else(is.na(hours.kronos),0,hours.kronos), chours.kronos=cumsum(hours.kronos)) %>%
  mutate(perc=chours.kronos/chours.budget)


write_xlsx(req.kro, paste(base.path,"output/BudgetVersusKronos.xlsx",sep=''))

p6.tmp<- labor$by.week.ctc %>% ungroup() %>% filter(week>=filt.st&week<filt.en) %>%
    select(FY=FY, d=week, Hours=dl.hours, Full.Name=person, department=code, ctc=ctc, role=Role) %>%
    mutate(LOE=ctc=='Q1903.01')%>%
    mutate(role.new=if_else(LOE=='TRUE'&role!="RA", "LOE", role)) %>%
  mutate(Full.Name=if_else(is.na(Full.Name),role.new,Full.Name)) %>%
  mutate(Last.Name=toupper(str_split_i(Full.Name,", ",i=1)))

hours.per.person.per.week <- p6.tmp %>% filter(d>=filt.asof) %>% ungroup() %>%
  select(week=d, Last.Name, ctc, hours=Hours) %>%
  group_by(Last.Name, week) %>% summarize(hours=sum(hours)) %>% ungroup() %>%
  arrange(Last.Name, week) %>% group_by(Last.Name) %>% mutate(chours=cumsum(hours))

```


The CompHours spreadsheet is important.  What's important, I think, 
is the difference in hours between P6 and kronos over the quarter.
The difficult question that may not have an answer is, what were those
hours used for?


```{r}

good.names <- charges%>%select(Last.Name, department=DSC) %>% distinct() %>% filter(department %in% c("ESH","ISD","FESS","ESHQ")) %>% pull(Last.Name)

good.names <- c("NOBREGA","CURFMAN","FUNK","HURD","KELLETT",
                "KOWALKOWSKI", "KIBURG", "PLUNKETT")

#good.names <- "NOBREGA|CURFMAN|FUNK|HURD|KELLETT|KOWAL|KIBURG|PLUNK|UNNAMED|MECH|SPECI|METRO|PARTICLE|SAFETY"

# hours.per.person.per.week is calulated in compare_labor.Rmd
comp.hours <- bind_rows(request=req.by.week%>%filter(week<=filt.en), 
                        kronos=select(kro,-Timecard.End), 
                        p6=hours.per.person.per.week, 
                        .id="src") 
#%>%
#  filter(Last.Name%in%good.names)

# p6.tmp%>% filter(Hours>0) %>% group_by(department,Full.Name) %>% summarize(tot=sum(Hours)) %>% arrange(Full.Name,department) %>% view()

calc_hour_diffs <- function(a,b)
{
  if_else(is.na(a),0.0,a) - if_else(is.na(b),0.0,b)
}

comp.hours.diff <- pivot_wider(comp.hours, names_from=c("src"), values_from=c("hours", "chours")) %>%
  mutate(hours_kronos=if_else(is.na(hours_kronos),0.0, hours_kronos), diff.kp=hours_kronos-hours_p6) %>%
  filter(Last.Name%in%good.names)

comp.hours.sum<- comp.hours%>% group_by(src,Last.Name) %>% summarize(total.hours=sum(hours)) %>% 
  pivot_wider(names_from=c("src"),values_from=c("total.hours")) %>% 
  arrange(Last.Name) %>% mutate(diff=calc_hour_diffs(kronos,p6))

write_xlsx(comp.hours.sum,paste(base.path,"output/CompHours_",filt.name,".xlsx",sep=''))


g3<- ggplot(comp.hours, aes(x=week, y=chours,colour=src)) +facet_wrap(vars(Last.Name),scales="free_y") + geom_line()
#g4<- ggplot(comp.hours.diff, aes(x=week, y=diff.kp)) +facet_wrap(vars(Last.Name),scales="free_y",ncol=1) + geom_line()

#print(g3)
#print(g4)
```

```{r}

tmp2<- person.comp %>% ungroup() %>% filter(ctc!="Q1903.01" & d>=as.Date("2023-10-01")) %>% select(from, d, isum=sum) %>% group_by(from,d)%>% summarise(sum=sum(isum)) %>% arrange(from, d) %>% group_by(from) %>% mutate(csum=cumsum(sum))

person.g4<- ggplot(tmp2,aes(x=d, colour=from)) + 
  geom_line(aes(y=csum)) +
  scale_color_hue(labels = c("Kronos", "p6")) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(name="cumulative hours",n.breaks=6) +
  scale_x_date(name="Date (by month)", date_breaks='1 month', date_labels = "%b %y")

#  geom_step(aes(y=csum)) +
#  facet_wrap(vars(from),scales="free_y")
print(person.g4)
```

```{r}
tmp.g <- ggplot(req.by.week %>% filter(str_detect(Last.Name, "NOBREGA|CURFMAN|FUNK|HURD|KELLETT"))
                , aes(x=week, y=chours)) + 
  geom_line() +
  facet_wrap(vars(Last.Name),scales="free_y", nrow=5) +
  scale_x_date(name="Date", date_breaks='1 week', date_labels = "%b %y") +
  scale_y_continuous(name="cumulative hours", n.breaks=6) +
        theme(axis.text.x = element_text(angle = 90))

print(tmp.g)
```


