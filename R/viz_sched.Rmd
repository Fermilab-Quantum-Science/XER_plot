---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=TRUE}
library(tidyverse)
library(ggplot2)
library(readxl)
library(stringr)
library(lubridate)

library(MAGIS100PM)
```


```{r}

sched_name <- "WS2309"
# note: if using WS schedule, the target dates need to be adjusted using the baseline
all.orig <- get.all.schedule(sched_name)
all <- apply.baseline.schedule(all.orig, "BCRBL2")

alldata<- all$all.data %>% filter(dur>0) %>%
  filter(target_start>as.Date('2022-10-01')) 
```
ISSUE: the g, a, and c are causing problem.   Fix them before continuing.

```{r}
label.cat <- c(
  "Assembly of modular sections",
  "Final shaft work",
  "Modular section and connection node installation",
"Atom sources",
"Atom source connection node",
"Atom source cameras",
"Assembly space/fixtures",
"Vacuum chamber",
"Vacuum system",
"Magnetic field systems",
"Strongback frame",
"Modular section cameras",
"Lower optics system",
"Transportation fixtures",
"Secondary crane",
"Installation planning",
"Installation fixtures",
"Connections to wall of shaft",
"Adjustable supports",
"Personnel access system",
"Shaft utilities",
"Electrical power",
"Electrical cables",
"DAQ computing and front end",
"Slow controls",
"Networking and storage",
"Interferometry laser system",
"Laser lab",
"Frequency comb",
"LTS supports",
"Interlocks",
"Machine protection system",
"Alignment", 
"Commissioning")

labels.ord <- data.frame(label=label.cat, ord=length(label.cat):1)
alldata.tmp <- alldata %>% left_join(labels.ord, by=join_by(label))
alldata.tmp$label <- reorder(alldata.tmp$label, alldata.tmp$ord)

alldata.tmp <- alldata.tmp %>%
  mutate(
    a=as.numeric(label)
  )

box.ys <- data.frame(category=c("Assembly","Shaft installation", "Shaft installation"), label=c("Assembly of modular sections", "Final shaft work", "Modular section and connection node installation"), ord=c(34,33,32), low=c(24,12,1), high=c(28,30,31))
                     # low=c(7,5,4), high=c(11,23,34))
box.xs <- alldata.tmp%>%filter(label.shape=="Box") %>% select(name, label, target_start, target_end,ord) %>% group_by(ord) %>% summarise(mi=min(target_start), mx=max(target_end))
box.spans <- left_join(box.ys, box.xs, by=join_by(ord)) %>% mutate(mid.x=mi+(mx-mi)/2, mid.y=low+(high-low)/2)

#alldata$label<-as.factor(alldata$label)
#label.cat2<- factor(label.cat,levels=label.cat)
#alldata$label<-factor(alldata$label,levels=label.cat)

```

This is the prototype visual schedule. 

Here are the name mappings:

* user_text5 = label.shape
* user_text4 = category
* user_text6 = label
* user_text1 = ctc

```{r}
tmp<-alldata.tmp
tmp$label.shape<-replace(tmp$label.shape,is.na(tmp$label.shape),"NA")

gp<-ggplot(tmp%>%filter(label.shape!="skip"), aes(xmin=target_start, xmax=target_end, 
                   y=label,# ymin = g, ymax = g+.8, 
                   fill = category)) +

  geom_rect(data=box.spans, aes(ymin=low,ymax=high,xmin=mi, xmax=mx), inherit.aes=FALSE,  fill=c("pink","limegreen","orange"), alpha=.4) +
  # colour=c("lightyellow","green","blue"),
  geom_text(data=box.spans, aes(x=mid.x,y=mid.y, label=label, angle=90),inherit.aes=FALSE, size=2) +
  
  geom_vline(aes(xintercept=as.Date("2023-10-01")))+
  geom_vline(aes(xintercept=as.Date("2024-10-01")))+
  geom_vline(aes(xintercept=as.Date("2025-10-01")))+
  geom_vline(aes(xintercept=as.Date("2026-10-01")))+
  geom_rect(aes(ymin = a-.4, ymax = a+.4)) +
  scale_y_discrete("label") +
  scale_x_date(name="date", date_breaks='1 month', date_labels = "%b %y") +
  theme(axis.text.x = element_text(angle = 90)) + 
  #geom_text(aes(x = as.Date(target_start), label = wbs), nudge_x=39.6, nudge_y=.2, size=3
  geom_text(aes(x = target_start, label = code, hjust="left",vjust="bottom"), size=.5, position=position_dodge2(width=.8)) +
  geom_linerange(aes(xmin = target_start, xmax = target_end), colour='blue', linewidth=.05, position=position_dodge2(width=.8))
  
print(gp)
ggsave(gp, filename=paste(base.path,'/output/VS-',sched_name,'.png',sep=''), width=12, height=12, units='in', device="png")
ggsave(gp, filename=paste(base.path,'/output/VS-',sched_name,'.pdf',sep=''), width=12, height=12, units='in', device="pdf")

```





